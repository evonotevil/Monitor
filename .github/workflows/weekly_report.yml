name: å…¨çƒæ¸¸æˆåˆè§„å‘¨æŠ¥

on:
  # æ¯å‘¨ä¸€ UTC 01:00 = åŒ—äº¬/æ–°åŠ å¡æ—¶é—´ 09:00
  schedule:
    - cron: '0 1 * * 1'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆSettings â†’ Actions â†’ Run workflowï¼‰
  workflow_dispatch:

permissions:
  contents: write   # å…è®¸ CI æäº¤æŠ¥å‘Šå›ä»“åº“

jobs:
  generate-and-notify:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. æ‹‰å–ä»£ç ï¼ˆå«å†å² DB + latest æŠ¥å‘Šï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 2. Python ç¯å¢ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install playwright
          playwright install --with-deps chromium

      # â”€â”€ 3. æŠ“å–æœ€æ–°æ•°æ® & ç”Ÿæˆ HTML æŠ¥å‘Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fetch data & generate HTML
        run: |
          python monitor.py run --period week
          python monitor.py report --format html --period week

      # â”€â”€ 4. ç”Ÿæˆ PDFï¼ˆåŒæ—¶å†™ latest.html / latest.pdfï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate PDF report
        run: python generate_pdf.py

      # â”€â”€ 5. è®¡ç®—æœ¬æ¬¡æŠ¥å‘Šçš„å…¬å¼€ URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set report URLs
        run: |
          REPO="${{ github.repository }}"
          BRANCH="main"
          BASE="https://raw.githubusercontent.com/${REPO}/${BRANCH}/reports"
          # htmlpreview.github.io å¯ä»¥åœ¨çº¿æ¸²æŸ“ GitHub raw HTMLï¼Œæ— éœ€å¼€ Pages
          echo "HTML_URL=https://htmlpreview.github.io/?${BASE}/latest.html" >> $GITHUB_ENV
          echo "PDF_URL=${BASE}/latest.pdf" >> $GITHUB_ENV

      # â”€â”€ 6. å‘é€é£ä¹¦å¡ç‰‡é€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Send Feishu notification
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          REPORT_HTML_URL:    ${{ env.HTML_URL }}
          REPORT_PDF_URL:     ${{ env.PDF_URL }}
        run: python feishu_notify.py

      # â”€â”€ 7. å°†æ›´æ–°åçš„ DB + latest æŠ¥å‘Šæäº¤å›ä»“åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit reports back to repo
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/latest.html reports/latest.pdf data/monitor.db
          # å¦‚æœæ²¡æœ‰å˜åŒ–å°±è·³è¿‡ commitï¼ˆé¿å…ç©ºæäº¤æŠ¥é”™ï¼‰
          git diff --staged --quiet || \
            git commit -m "ğŸ“Š å‘¨æŠ¥ $(date -u +%Y-%m-%d) [skip ci]"
          git push
